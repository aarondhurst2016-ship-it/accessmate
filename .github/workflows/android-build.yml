name: Build Android APK

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  PYTHON_VERSION: '3.11'

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          unzip \
          zip \
          zlib1g-dev \
          libncurses5-dev \
          libgdbm-dev \
          libnss3-dev \
          libssl-dev \
          libreadline-dev \
          libffi-dev \
          libsqlite3-dev \
          libbz2-dev \
          liblzma-dev \
          libncursesw5-dev \
          xz-utils \
          tk-dev \
          libxml2-dev \
          libxmlsec1-dev \
          libffi-dev \
          liblzma-dev
    
    - name: Cache buildozer global directory
      uses: actions/cache@v3
      with:
        path: ~/.buildozer
        key: buildozer-global-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          buildozer-global-
    
    - name: Cache buildozer build directory
      uses: actions/cache@v3
      with:
        path: .buildozer
        key: buildozer-${{ hashFiles('buildozer.spec') }}-${{ hashFiles('mobial/**') }}
        restore-keys: |
          buildozer-${{ hashFiles('buildozer.spec') }}-
          buildozer-
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer python-for-android cython
        pip install -r requirements.txt || echo "No requirements.txt found"
    
    - name: Validate buildozer.spec
      run: |
        echo "Validating buildozer.spec configuration..."
        if [ ! -f buildozer.spec ]; then
          echo "ERROR: buildozer.spec not found!"
          exit 1
        fi
        
        # Check required files exist
        if [ ! -d mobial ]; then
          echo "ERROR: mobial/ directory not found!"
          exit 1
        fi
        
        if [ ! -f mobial/main.py ]; then
          echo "ERROR: mobial/main.py not found!"
          exit 1
        fi
        
        echo "[PASS] buildozer.spec validation passed"
    
    - name: Prepare build environment
      run: |
        echo "Setting up build environment..."
        
        # Create necessary directories
        mkdir -p ~/.buildozer
        mkdir -p .buildozer
        
        # Set environment variables for buildozer
        export ANDROIDAPI="34"
        export NDKAPI="21"
        export ANDROID_HOME="$HOME/.buildozer/android/platform/android-sdk"
        export ANDROID_SDK_ROOT="$ANDROID_HOME"
        export PATH="$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools"
        
        echo "[PASS] Build environment prepared"
    
    - name: Build Android APK (Debug)
      if: github.event.inputs.build_type != 'release'
      run: |
        echo "[BUILD] Building DEBUG APK..."
        buildozer android debug
        
        # Verify APK was created
        if [ -f bin/*.apk ]; then
          echo "[SUCCESS] DEBUG APK build successful!"
          ls -la bin/*.apk
        else
          echo "[ERROR] DEBUG APK build failed - no APK found"
          exit 1
        fi

    - name: Check for signing secrets
      id: check-secrets
      if: github.event.inputs.build_type == 'release'
      env:
        ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
        ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      run: |
        if [ -n "$ANDROID_KEYSTORE" ] && [ -n "$ANDROID_KEYSTORE_PASSWORD" ] && [ -n "$ANDROID_KEY_ALIAS" ]; then
          echo "has-secrets=true" >> $GITHUB_OUTPUT
        else
          echo "has-secrets=false" >> $GITHUB_OUTPUT
        fi

    - name: Build Android APK (Release - Signed)
      if: github.event.inputs.build_type == 'release' && steps.check-secrets.outputs.has-secrets == 'true'
      run: |
        echo "[BUILD] Building SIGNED RELEASE APK..."

        # Export secrets as environment variables
        export ANDROID_KEYSTORE="${{ secrets.ANDROID_KEYSTORE }}"
        export ANDROID_KEYSTORE_PASSWORD="${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"
        export ANDROID_KEY_ALIAS="${{ secrets.ANDROID_KEY_ALIAS }}"
        export ANDROID_KEY_PASSWORD="${{ secrets.ANDROID_KEY_PASSWORD }}"

        # Write the keystore file from the secret
        echo "$ANDROID_KEYSTORE" | base64 -d > android-release-key.keystore
        
        # Create signing configuration
        echo "" >> buildozer.spec
        echo "# Release signing configuration" >> buildozer.spec
        echo "android.release_artifact = aab" >> buildozer.spec
        echo "android.debug_artifact = apk" >> buildozer.spec
        echo "android.keystore = android-release-key.keystore" >> buildozer.spec
        echo "android.keyalias = $ANDROID_KEY_ALIAS" >> buildozer.spec
        echo "android.keystorepass = $ANDROID_KEYSTORE_PASSWORD" >> buildozer.spec
        if [ -n "$ANDROID_KEY_PASSWORD" ]; then
          echo "android.keypass = $ANDROID_KEY_PASSWORD" >> buildozer.spec
        fi

        buildozer android release
        
        # Verify APK was created
        if [ -f bin/*.apk ]; then
          echo "[SUCCESS] SIGNED RELEASE APK build successful!"
          ls -la bin/*.apk
        else
          echo "[ERROR] SIGNED RELEASE APK build failed - no APK found"
          exit 1
        fi

    - name: Build Android APK (Release - Unsigned)
      if: github.event.inputs.build_type == 'release' && steps.check-secrets.outputs.has-secrets == 'false'
      run: |
        echo "[BUILD] Building UNSIGNED RELEASE APK..."
        echo "[WARN] No signing secrets configured, building unsigned release"
        echo "[INFO] To enable signed releases, add these GitHub secrets:"
        echo "   - ANDROID_KEYSTORE (base64 encoded keystore file)"
        echo "   - ANDROID_KEYSTORE_PASSWORD"
        echo "   - ANDROID_KEY_ALIAS"
        echo "   - ANDROID_KEY_PASSWORD"

        buildozer android release
        
        # Verify APK was created
        if [ -f bin/*.apk ]; then
          echo "[SUCCESS] UNSIGNED RELEASE APK build successful!"
          ls -la bin/*.apk
        else
          echo "[ERROR] UNSIGNED RELEASE APK build failed - no APK found"
          exit 1
        fi

    - name: Analyze APK
      if: success()
      run: |
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "[ANALYSIS] APK Analysis:"
          APK_FILE=$(ls bin/*.apk | head -1)
          echo "APK File: $APK_FILE"
          echo "APK Size: $(du -h "$APK_FILE" | cut -f1)"
          echo "File type: $(file "$APK_FILE")"
          
          # Install Android build tools for analysis
          sudo apt-get update -qq
          sudo apt-get install -y -qq aapt || echo "Could not install aapt"
          
          if command -v aapt >/dev/null 2>&1; then
            echo "APK Package Info:"
            aapt dump badging "$APK_FILE" | head -5 || echo "Could not get package info"
            echo "APK Permissions:"
            aapt dump permissions "$APK_FILE" || echo "Could not analyze permissions"
          else
            echo "aapt not available for detailed analysis"
          fi
        else
          echo "[WARN] No APK files found for analysis"
        fi
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: android-apk-${{ github.run_number }}
        path: bin/*.apk
        retention-days: 30
    
    - name: Upload build logs
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          .buildozer/
          *.log
        retention-days: 7
    
    - name: Comment PR with APK info
      if: github.event_name == 'pull_request' && success()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Find APK file
          const binDir = 'bin';
          let apkInfo = 'APK built successfully!';
          
          try {
            if (fs.existsSync(binDir)) {
              const files = fs.readdirSync(binDir);
              const apkFiles = files.filter(f => f.endsWith('.apk'));
              
              if (apkFiles.length > 0) {
                const apkFile = path.join(binDir, apkFiles[0]);
                const stats = fs.statSync(apkFile);
                const fileSizeInMB = (stats.size / (1024 * 1024)).toFixed(2);
                
                apkInfo = "## Android APK Built Successfully!\n\n" +
                         "**APK Details:**\n" +
                         "- File: `" + apkFiles[0] + "`\n" +
                         "- Size: " + fileSizeInMB + " MB\n" +
                         "- Build: ${{ github.run_number }}\n" +
                         "- Commit: ${{ github.sha }}\n\n" +
                         "Download the APK from the workflow artifacts above.";
              }
            }
          } catch (error) {
            console.log('Error reading APK info:', error);
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: apkInfo
          });

  test-android-apk:
    runs-on: ubuntu-latest
    needs: build-android
    if: success()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download APK artifact
      uses: actions/download-artifact@v3
      with:
        name: android-apk-${{ github.run_number }}
        path: apk/
    
    - name: Install APK analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y aapt
    
    - name: Analyze APK structure
      run: |
        APK_FILE=$(ls apk/*.apk | head -1)
        echo "[ANALYZE] Analyzing APK: $APK_FILE"
        
        echo "## APK Information"
        aapt dump badging "$APK_FILE" | head -10
        
        echo -e "\n## Permissions"
        aapt dump permissions "$APK_FILE"
        
        echo -e "\n## Features"
        aapt dump configurations "$APK_FILE"
        
        echo -e "\n## APK Contents"
        aapt list "$APK_FILE" | head -20