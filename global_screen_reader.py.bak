import time
import pyttsx3
from pywinauto import Desktop
import pywinauto
import threading

engine = pyttsx3.init()
last_text = None


def speak(text):
    engine.stop()
    engine.say(text)
    engine.runAndWait()

def get_element_under_mouse():
    try:
        mouse = pywinauto.mouse.get_cursor_pos()
        elem = Desktop(backend="uia").from_point(mouse)
        name = elem.window_text() or elem.element_info.name or elem.element_info.control_type
        return name
    except Exception:
        return None

def monitor_mouse():
    global last_text
    last_time = 0
    last_elem = None
    hover_start = None
    announced_this_hover = False
    while True:
        text = get_element_under_mouse()
        if text != last_elem:
            hover_start = time.time()
            last_elem = text
            announced_this_hover = False
        if text and not announced_this_hover:
            if hover_start and (time.time() - hover_start) >= 10:
                speak(text)
                last_text = text
                announced_this_hover = True
        time.sleep(0.5)

if __name__ == "__main__":
    print("Global screen reader started. Move your mouse over desktop or menus to hear their names.")
    t = threading.Thread(target=monitor_mouse, daemon=True)
    t.start()
    while True:
        time.sleep(1)
